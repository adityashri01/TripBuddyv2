<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TripBuddy</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>

    <header class="dashboard-header">
        <div class="header-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='images/tripbuddy.png') }}" alt="TripBuddy Logo" class="logo-img">
            </div>
            <div class="header-right-section">
                <nav class="dashboard-nav-header">
                    <ul>
                        <li><a href="{{ url_for('find_rides') }}" {% if not can_find_rides %}class="disabled-link"{% endif %}>Find Rides</a></li>
                        <li><a href="{{ url_for('post_ride') }}" {% if not can_offer_rides %}class="disabled-link"{% endif %}>Post Ride</a></li>
                        
                    </ul>
                </nav>
                <div class="header-actions">
    <button class="notification-bell" aria-label="Notifications">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notification-count">0</span> </button>
    <div class="notification-dropdown" id="notification-dropdown">
        <div class="dropdown-header">
            <h3>Notifications</h3>
            <span class="mark-all-read" id="mark-all-read">Mark all as read</span>
        </div>
        <div class="notification-list" id="notification-list">
            <p class="no-notifications-message">No new notifications.</p>
        </div>
        <div class="dropdown-footer">
            <a href="#">View All Notifications</a>
        </div>
    </div>
    <a href="{{ url_for('home') }}" class="logout-btn-header">Home</a>
    <a href="{{ url_for('logout') }}" class="logout-btn-header">Logout</a>
</div>
            </div>
        </div>
    </header>

    <main>
        <div class="dashboard-content">
            <h1 class="welcome-heading">Welcome, {{ name }}!</h1>

            <div class="user-summary-section">
                <div class="user-avatar-placeholder">
                    <i class="fas fa-user-circle"></i> </div>
                <div class="user-details">
                    <p class="logged-in-as"><i class="fas fa-info-circle info-icon"></i> You are logged in as a:</p>
                    <p class="user-role-display">
                        {% if role == 'Renter' %}
                            <i class="fas fa-user-tag role-icon"></i> Renter
                        {% elif role == 'Provider' %}
                            <i class="fas fa-car-side role-icon"></i> Provider
                        {% elif role == 'Renter, Provider' %}
                            <i class="fas fa-handshake role-icon"></i> Renter & Provider
                        {% else %}
                            <i class="fas fa-user role-icon"></i> {{ role }} {% endif %}
                    </p>
                    <p class="user-email-display"><i class="fas fa-envelope email-icon"></i> {{ current_user.email }}</p>

                    <p class="user-meta-info"><i class="fas fa-clock meta-icon"></i> Last Login: {{ current_user.last_login_date | default('N/A') }}</p>
                    <p class="user-meta-info">
                        {% if current_user.is_email_verified %}
                            <i class="fas fa-check-circle verified-icon"></i> Email Verified
                        {% else %}
                            <i class="fas fa-exclamation-triangle unverified-icon"></i> Email Not Verified (<a href="#" class="verify-link">Verify Now</a>)
                        {% endif %}
                    </p>

                    <a href="#" class="edit-profile-link"><i class="fas fa-edit"></i> Edit Profile</a>
                </div>
            </div>
        </div>



        {% if role.lower() == 'renter' and not can_offer_rides %}
        <div class="provider-cta-section">
            <div class="provider-cta-text">
                <h2>Want to Offer Rides?</h2>
                <p>Activate this feature to start sharing your journey and earning.</p>
            </div>
            <form action="{{ url_for('activate_offer_rides') }}" method="POST">
                <button type="submit" class="become-provider-btn">Activate Offer Rides</button>
            </form>
        </div>
        {% elif role.lower() == 'provider' and not can_find_rides %}
        <div class="provider-cta-section">
            <div class="provider-cta-text">
                <h2>Want to Book a Ride?</h2>
                <p>Activate this feature to find and book rides offered by others.</p>
            </div>
            <form action="{{ url_for('activate_find_rides') }}" method="POST">
                <button type="submit" class="become-provider-btn">Activate Find Rides</button>
            </form>
        </div>
        {% endif %}

        <div class="dashboard-stats-grid">
            <div class="stat-card">
                <h3 class="stat-title">Rides Offered</h3>
                <i class="fas fa-car stat-icon"></i>
                <p class="stat-value">{{ rides_offered_count | default(0) }}</p>
                <p class="stat-description">Your active ride offers</p>
            </div>
            <div class="stat-card">
                <h3 class="stat-title">Rides Taken</h3>
                <i class="fas fa-road stat-icon"></i>
                <p class="stat-value">{{ rides_taken_count | default(0) }}</p>
                <p class="stat-description">Seats booked by you</p>
            </div>
            <div class="stat-card">
                <h3 class="stat-title">Average Rating</h3>
                <i class="fas fa-star stat-icon"></i>
                <p class="stat-value">{{ average_rating | default('N/A') }}</p>
                <p class="stat-description">Dynamic data</p>
            </div>
            <div class="stat-card">
                <h3 class="stat-title">Wallet Balance</h3>
                <i class="fas fa-wallet stat-icon"></i>
                <p class="stat-value">{{ wallet_balance | default('0.00') }}</p>
                <p class="stat-description">Dynamic data</p>
            </div>
        </div>

        <section class="quick-actions-section">
            <h2 class="quick-actions-heading">Quick Actions</h2>
            <div class="action-grid">
                <a href="{{ url_for('find_rides') }}" class="action-card {% if not can_find_rides %}disabled-card{% endif %}">
                    <i class="fas fa-search action-icon"></i>
                    <p class="action-text">Find a Ride</p>
                </a>
                <a href="{{ url_for('post_ride') }}" class="action-card {% if not can_offer_rides %}disabled-card{% endif %}">
                    <i class="fas fa-plus-circle action-icon"></i>
                    <p class="action-text">Offer a Ride</p>
                </a>
                <a href="{{ url_for('my_rides') }}" class="action-card"> {# Updated to My Rides #}
                    <i class="fas fa-history action-icon"></i>
                    <p class="action-text">My Rides</p>
                </a>
                <a href="#" class="action-card">
                    <i class="fas fa-comments action-icon"></i>
                    <p class="action-text">Messages</p>
                </a>
                <a href="#" class="action-card">
                    <i class="fas fa-cog action-icon"></i>
                    <p class="action-text">Settings</p>
                </a>
            </div>
        </section>
        <h2 class="main-activity-title">Your Activity</h2>
        <section class="activity-cards-grid">
            <div class="card discover-adventure-card">
                <h3>Discover Your Next Adventure</h3>
                <p>Search for available rides or connect with fellow travelers.</p>
                <form class="search-ride-form">
                    <input type="text" placeholder="From where?" class="form-input">
                    <input type="text" placeholder="To where?" class="form-input">
                    <button type="submit" class="btn btn-primary">Search Rides <i class="fas fa-arrow-right"></i></button>
                </form>
            </div>

            <div class="card active-offers-card">
                <h3>Your Active Ride Offers</h3>
                {% if user_rides %}
                    <ul class="offer-list">
                        {% for ride in user_rides %}
                            <li class="offer-item">
                                <span class="offer-route">{{ ride.start_location }} to {{ ride.end_location }}</span>
                                <span class="offer-details">Price: â‚¹{{ "%.2f"|format(ride.price) }} | Available Seats: {{ ride.seats }}</span>
                                <div class="offer-actions">
                                    <a href="#" class="btn btn-sm btn-info">Edit</a>
                                    <a href="#" class="btn btn-sm btn-danger">Cancel</a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="no-offers-message"><i class="fas fa-info-circle"></i> You currently have no active ride offers.</p>
                    <a href="{{ url_for('post_ride') }}" class="btn btn-secondary-outline">Post a New Ride</a>
                {% endif %}
            </div>
            </section>
        </main>

    <footer class="main-footer section-padding">
        <div class="footer-container container">
            <div class="footer-links-group">
                <h4>Quick Links</h4>
                <a href="{{ url_for('home') }}">Home</a>
                <a href="{{ url_for('home') }}#how-it-works">How It Works</a>
                <a href="{{ url_for('about') }}">About Us</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
            </div>
            <div class="footer-contact-group">
                <h4>Contact Us</h4>
                <p><i class="fas fa-envelope"></i> Email: support@tripbuddy.com</p>
                <p><i class="fas fa-phone"></i> Phone: +91-98765XXXXX</p>
                <p><i class="fas fa-map-marker-alt"></i> Address: 123,Lona,Delhi, India</p>
            </div>
            <div class="footer-social-group">
                <h4>Follow Us</h4>
                <div class="social-icons">
                    <a href="https://www.facebook.com" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="https://www.twitter.com" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="https://www.linkedin.com" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
            <div class="footer-newsletter-group">
                <h4>Subscribe to Our Newsletter</h4>
                <form class="newsletter-form">
                    <input type="email" placeholder="Your email" required />
                    <button type="submit">Subscribe</button>
                </form>
            </div>
        </div>
        <p class="footer-copy">&copy; 2025 TripBuddy. All rights reserved.</p>
    </footer>

     <script>
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBell = document.querySelector('.notification-bell');
            const notificationDropdown = document.getElementById('notification-dropdown');
            const notificationCountBadge = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const markAllReadBtn = document.getElementById('mark-all-read');
            const noNotificationsMessage = notificationList.querySelector('.no-notifications-message'); // Get the placeholder message

            let notifications = []; // This will now be populated from the backend

            // Helper function to format timestamps
            function formatTimestamp(isoString) {
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = now - date;
                const diffSeconds = Math.round(diffMs / 1000);
                const diffMinutes = Math.round(diffSeconds / 60);
                const diffHours = Math.round(diffMinutes / 60);
                const diffDays = Math.round(diffHours / 24);
                const diffMonths = Math.round(diffDays / 30.44); // Average days in a month
                const diffYears = Math.round(diffDays / 365.25);

                if (diffSeconds < 60) {
                    return `${diffSeconds} second${diffSeconds === 1 ? '' : 's'} ago`;
                } else if (diffMinutes < 60) {
                    return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
                } else if (diffHours < 24) {
                    return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
                } else if (diffDays < 7) {
                    return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
                } else if (diffMonths < 12) {
                    return `${diffMonths} month${diffMonths === 1 ? '' : 's'} ago`;
                } else {
                    return `${diffYears} year${diffYears === 1 ? '' : 's'} ago`;
                }
            }

            // Function to fetch notifications from the backend
            async function fetchNotifications() {
                try {
                    const response = await fetch('/api/notifications');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    notifications = await response.json();
                    renderNotifications();
                } catch (error) {
                    console.error('Error fetching notifications:', error);
                    // Optionally display an error message to the user
                    notificationList.innerHTML = '<p class="no-notifications-message" style="color:red;">Failed to load notifications.</p>';
                    updateNotificationCount(0); // Hide badge on error
                }
            }

            // Function to render notifications
            function renderNotifications() {
                notificationList.innerHTML = ''; // Clear existing notifications
                let unreadCount = 0;

                if (notifications.length === 0 || notifications.every(notif => notif.is_read)) {
                    // Show "No new notifications" only if there are no notifications or all are read
                    if (noNotificationsMessage) { // Ensure the element exists
                        notificationList.appendChild(noNotificationsMessage.cloneNode(true)); // Clone to re-add it
                    } else {
                        const message = document.createElement('p');
                        message.classList.add('no-notifications-message');
                        message.textContent = 'No new notifications.';
                        notificationList.appendChild(message);
                    }
                    updateNotificationCount(0);
                    return;
                }

                notifications.forEach(notif => {
                    if (!notif.is_read) { // Use is_read from backend
                        unreadCount++;
                    }
                    const notificationItem = document.createElement('div');
                    notificationItem.classList.add('notification-item');
                    if (!notif.is_read) { // Use is_read for class
                        notificationItem.classList.add('unread');
                    }
                    notificationItem.dataset.id = notif.id; // Store ID for easy access

                    notificationItem.innerHTML = `
                        <div class="notification-item-header">
                            <span class="notification-type">${notif.type || 'General'}</span>
                            <span class="timestamp">${formatTimestamp(notif.timestamp)}</span>
                        </div>
                        <div class="notification-item-content">
                            ${notif.message}
                        </div>
                    `;
                    notificationList.appendChild(notificationItem);

                    // Add click listener to mark as read
                    notificationItem.addEventListener('click', async function() {
                        if (!notif.is_read) { // Only try to mark as read if it's currently unread
                            await markNotificationAsRead(notif.id);
                        }
                    });
                });

                updateNotificationCount(unreadCount);
            }

            // Function to update the notification count badge
            function updateNotificationCount(count) {
                if (count > 0) {
                    notificationCountBadge.textContent = count;
                    notificationCountBadge.style.display = 'block';
                } else {
                    notificationCountBadge.style.display = 'none';
                }
            }

            // Function to mark a single notification as read on the backend
            async function markNotificationAsRead(id) {
                try {
                    const response = await fetch(`/api/notifications/${id}/mark_read`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    if (response.ok) {
                        const notification = notifications.find(n => n.id === id);
                        if (notification) {
                            notification.is_read = true; // Update local state
                            renderNotifications(); // Re-render to update UI
                        }
                    } else {
                        console.error('Failed to mark notification as read:', await response.text());
                    }
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            }

            // Function to mark all notifications as read on the backend
            markAllReadBtn.addEventListener('click', async function() {
                try {
                    const response = await fetch('/api/notifications/mark_all_read', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    if (response.ok) {
                        notifications.forEach(notif => {
                            notif.is_read = true; // Update local state
                        });
                        renderNotifications();
                    } else {
                        console.error('Failed to mark all notifications as read:', await response.text());
                    }
                } catch (error) {
                    console.error('Error marking all notifications as read:', error);
                }
            });

            // Toggle dropdown visibility and fetch notifications
            notificationBell.addEventListener('click', async function(event) {
                notificationDropdown.classList.toggle('show');
                if (notificationDropdown.classList.contains('show')) {
                    await fetchNotifications(); // Fetch and render when dropdown opens
                }
                event.stopPropagation();
            });

            // Close dropdown if clicked outside
            document.addEventListener('click', function(event) {
                if (!notificationDropdown.contains(event.target) && !notificationBell.contains(event.target)) {
                    notificationDropdown.classList.remove('show');
                }
            });

            // Initial fetch of notifications when page loads
            fetchNotifications();

            // Optional: Periodically fetch notifications (e.g., every 60 seconds)
            // setInterval(fetchNotifications, 60000); // Fetch every minute
        });
    </script>

    </body>
</html>
