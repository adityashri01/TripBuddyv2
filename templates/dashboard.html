<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TripBuddy</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>

    <header class="dashboard-header">
        <div class="header-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='images/tripbuddy.png') }}" alt="TripBuddy Logo" class="logo-img">
            </div>
            <div class="header-right-section">
                <nav class="dashboard-nav-header">
                    <ul>
                        <li><a href="{{ url_for('find_rides') }}" {% if not can_find_rides %}class="disabled-link"{% endif %}>Find Rides</a></li>
                        <li><a href="{{ url_for('post_ride') }}" {% if not can_offer_rides %}class="disabled-link"{% endif %}>Post Ride</a></li>
                        
                    </ul>
                </nav>
                <div class="header-actions">
    <button class="notification-bell" aria-label="Notifications">
        <i class="fas fa-bell"></i>
        <!-- IMPORTANT: Added inline style for visibility debugging. You can remove this after confirming it works. -->
        <span class="notification-badge" id="notification-count" style="display: none; background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.75em; position: absolute; top: -5px; right: -5px;">0</span>
    </button>
    <div class="notification-dropdown" id="notification-dropdown">
        <div class="dropdown-header">
            <h3>Notifications</h3>
            <span class="mark-all-read" id="mark-all-read">Mark all as read</span>
        </div>
        <div class="notification-list" id="notification-list">
            <p class="no-notifications-message">No new notifications.</p>
        </div>
        <div class="dropdown-footer">
            <a href="#">View All Notifications</a>
        </div>
    </div>
    <a href="{{ url_for('home') }}" class="logout-btn-header">Home</a>
    <a href="{{ url_for('logout') }}" class="logout-btn-header">Logout</a>
</div>
            </div>
        </div>
    </header>

    <main>
        <div class="dashboard-content">
            <h1 class="welcome-heading">Welcome, {{ name }}!</h1>

<div class="user-summary-section">
    <div class="user-avatar-placeholder">
        <i class="fas fa-user-circle"></i> </div>
    <div class="user-details">
        <p class="logged-in-as"><i class="fas fa-info-circle info-icon"></i> You are logged in as a:</p>
        <p class="user-role-display">
            {% if role == 'Renter' %}
                <i class="fas fa-user-tag role-icon"></i> Renter
            {% elif role == 'Provider' %}
                <i class="fas fa-car-side role-icon"></i> Provider
            {% elif role == 'Renter, Provider' %}
                <i class="fas fa-handshake role-icon"></i> Renter & Provider
            {% else %}
                <i class="fas fa-user role-icon"></i> {{ role }} {% endif %}
        </p>
        <p class="user-email-display"><i class="fas fa-envelope email-icon"></i> {{ current_user.email }}</p>
        <p class="user-phone-display"><i class="fas fa-phone-alt phone-icon"></i> {{ current_user.phone_number }}</p>
        <p class="user-meta-info"><i class="fas fa-clock meta-icon"></i> Last Login: {{ last_login_date.strftime('%Y-%m-%d %H:%M:%S') if last_login_date else 'N/A' }}</p>
        <p class="user-meta-info">
            {% if is_email_verified %}
                <i class="fas fa-check-circle verified-icon"></i> Email Verified
            {% else %}
                <i class="fas fa-exclamation-triangle unverified-icon"></i> Email Not Verified (<a href="{{ url_for('login') }}" class="verify-link">Resend Verification Email</a>)
            {% endif %}
        </p>

        <div class="verify-doc-container">
  <a href="{{ url_for('verify_document') }}" class="btn-verify-doc">Verify Document</a>
</div>


    </div>
</div>
        </div>



        {% if role.lower() == 'renter' and not can_offer_rides %}
        <div class="provider-cta-section">
            <div class="provider-cta-text">
                <h2>Want to Offer Rides?</h2>
                <p>Activate this feature to start sharing your journey and earning.</p>
            </div>
            <form action="{{ url_for('activate_offer_rides') }}" method="POST">
                <button type="submit" class="become-provider-btn">Activate Offer Rides</button>
            </form>
        </div>
        {% elif role.lower() == 'provider' and not can_find_rides %}
        <div class="provider-cta-section">
            <div class="provider-cta-text">
                <h2>Want to Book a Ride?</h2>
                <p>Activate this feature to find and book rides offered by others.</p>
            </div>
            <form action="{{ url_for('activate_find_rides') }}" method="POST">
                <button type="submit" class="become-provider-btn">Activate Find Rides</button>
            </form>
        </div>
        {% endif %}

        <div class="dashboard-stats-grid">
           <a href="{{ url_for('my_rides', filter='offered') }}" class="stat-card">
    <h3 class="stat-title">Rides Offered</h3>
    <i class="fas fa-car stat-icon"></i>
    <p class="stat-value">{{ rides_offered_count | default(0) }}</p>
    <p class="stat-description">Your active ride offers</p>
</a>

<a href="{{ url_for('my_rides', filter='rented') }}" class="stat-card">
    <h3 class="stat-title">Rides Taken</h3>
    <i class="fas fa-road stat-icon"></i>
    <p class="stat-value">{{ rides_taken_count | default(0) }}</p>
    <p class="stat-description">Seats booked by you</p>
</a>

            <div class="stat-card">
                <h3 class="stat-title">Average Rating</h3>
                <i class="fas fa-star stat-icon"></i>
                <p class="stat-value">{{ average_rating | default('N/A') }}</p>
                <p class="stat-description">Dynamic data</p>
            </div>
            <div class="stat-card">
                <h3 class="stat-title">Wallet Balance</h3>
                <i class="fas fa-wallet stat-icon"></i>
                <p class="stat-value">{{ wallet_balance | default('0.00') }}</p>
                <p class="stat-description">Dynamic data</p>
            </div>
        </div>

        <section class="quick-actions-section">
            <h2 class="quick-actions-heading">Quick Actions</h2>
            <div class="action-grid">
                <a href="{{ url_for('find_rides') }}" class="action-card {% if not can_find_rides %}disabled-card{% endif %}">
                    <i class="fas fa-search action-icon"></i>
                    <p class="action-text">Find a Ride</p>
                </a>
                <a href="{{ url_for('post_ride') }}" class="action-card {% if not can_offer_rides %}disabled-card{% endif %}">
                    <i class="fas fa-plus-circle action-icon"></i>
                    <p class="action-text">Offer a Ride</p>
                </a>
                <a href="{{ url_for('my_rides') }}" class="action-card"> {# Updated to My Rides #}
                    <i class="fas fa-history action-icon"></i>
                    <p class="action-text">My Rides</p>
                </a>
                <a href="{{ url_for('contact') }}" class="action-card">
                    <i class="fas fa-comments action-icon"></i>
                    <p class="action-text">Help</p>
                </a>
                <a href="{{ url_for('settings') }}" class="action-card">
                    <i class="fas fa-cog action-icon"></i>
                    <p class="action-text">Settings</p>
                </a>
            </div>
        </section>
        <h2 class="main-activity-title">Your Activity</h2>
        <section class="activity-cards-grid">
            <div class="card discover-adventure-card">
                <h3>Discover Your Next Adventure</h3>
                <p>Search for available rides or connect with fellow travelers.</p>
                <form class="search-ride-form" action="{{ url_for('find_rides') }}" method="GET">
                    <input type="text" name="origin" placeholder="From where?" class="form-input">
                    <input type="text" name="destination" placeholder="To where?" class="form-input">
                    <button type="submit" class="btn btn-primary">Search Rides <i class="fas fa-arrow-right"></i></button>
                </form>
            </div>

            <div class="card active-offers-card">
                <h3>Your Active Ride Offers</h3>
                {% if user_rides %}
                    <ul class="offer-list">
                        {% for ride in user_rides %}
                            <li class="offer-item">
                                <span class="offer-route">{{ ride.start_location }} to {{ ride.end_location }}</span>
                                <span class="offer-details">Price: â‚¹{{ "%.2f"|format(ride.price) }} | Available Seats: {{ ride.seats }}</span>
                                <div class="offer-actions">
                                    <a href="#" class="btn btn-sm btn-info">Edit</a>
                                    <a href="#" class="btn btn-sm btn-danger">Cancel</a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="no-offers-message"><i class="fas fa-info-circle"></i> You currently have no active ride offers.</p>
                    <a href="{{ url_for('post_ride') }}" class="btn btn-secondary-outline">Post a New Ride</a>
                {% endif %}
            </div>
            </section>
        </main>

    <footer class="main-footer section-padding">
        <div class="footer-container container">
            <div class="footer-links-group">
                <h4>Quick Links</h4>
                <a href="{{ url_for('home') }}">Home</a>
                <a href="{{ url_for('home') }}#how-it-works">How It Works</a>
                <a href="{{ url_for('about') }}">About Us</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
            </div>
            <div class="footer-contact-group">
                <h4>Contact Us</h4>
                <p><i class="fas fa-envelope"></i> Email: tripbuddy898@gmail.com</p>
                <p><i class="fas fa-phone"></i> Phone: +91-98765XXXXX</p>
                <p><i class="fas fa-map-marker-alt"></i> Address: 123,Lona,Delhi, India</p>
            </div>
            <div class="footer-social-group">
                <h4>Follow Us</h4>
                <div class="social-icons">
                    <a href="https://www.facebook.com" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="https://www.twitter.com" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="https://www.linkedin.com" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
            <div class="footer-newsletter-group">
                <h4>Subscribe to Our Newsletter</h4>
                <form class="newsletter-form">
                    <input type="email" placeholder="Your email" required />
                    <button type="submit">Subscribe</button>
                </form>
            </div>
        </div>
        <p class="footer-copy">&copy; 2025 TripBuddy. All rights reserved.</p>
    </footer>

    <!-- Include Socket.IO client library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>

     <script>
       document.addEventListener('DOMContentLoaded', function() {
    const notificationBell = document.querySelector('.notification-bell');
    const notificationDropdown = document.getElementById('notification-dropdown');
    const notificationList = document.getElementById('notification-list');
    const notificationCountSpan = document.getElementById('notification-count');
    const markAllReadButton = document.getElementById('mark-all-read');

    // Initialize Socket.IO connection
    const socket = io(); // Connects to the current host/port

    socket.on('connect', function() {
        console.log('Connected to Socket.IO server');
    });

    // Listen for new_notification events from the server
    socket.on('new_notification', function(data) {
        console.log('New notification received via Socket.IO:', data);
        // Re-fetch and render all notifications to update the count and list
        fetchAndRenderNotifications();
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from Socket.IO server');
    });


    // Function to fetch and render notifications
    async function fetchAndRenderNotifications() {
        try {
            const response = await fetch('/api/notifications');
            const notifications = await response.json();
            
            // Clear existing notifications
            notificationList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '<p class="no-notifications-message">No new notifications.</p>';
                notificationCountSpan.style.display = 'none'; // Hide if no notifications
            } else {
                let unreadCount = 0;
                notifications.forEach(notif => {
                    const notificationItem = document.createElement('div');
                    notificationItem.classList.add('notification-item');
                    if (!notif.is_read) {
                        notificationItem.classList.add('unread');
                        unreadCount++;
                    }
                    notificationItem.dataset.id = notif.id;

                    const notificationHeader = document.createElement('div');
                    notificationHeader.classList.add('notification-item-header');

                    const notificationType = document.createElement('span');
                    notificationType.classList.add('notification-type');
                    notificationType.textContent = notif.type; 

                    const notificationTimestamp = document.createElement('span');
                    notificationTimestamp.classList.add('timestamp');
                    notificationTimestamp.textContent = new Date(notif.timestamp).toLocaleString();

                    const notificationContent = document.createElement('div');
                    notificationContent.classList.add('notification-item-content');
                    notificationContent.textContent = notif.message;

                    notificationHeader.appendChild(notificationType);
                    notificationHeader.appendChild(notificationTimestamp);
                    notificationItem.appendChild(notificationHeader);
                    notificationItem.appendChild(notificationContent);
                    notificationList.appendChild(notificationItem);

                    // Add click listener to mark individual notification as read
                    notificationItem.addEventListener('click', async () => {
                        if (!notif.is_read) { // Only mark as read if it's unread
                            try {
                                const markReadResponse = await fetch(`/api/notifications/${notif.id}/mark_read`, {
                                    method: 'POST',
                                });
                                if (markReadResponse.ok) {
                                    // Update UI directly for this item
                                    notificationItem.classList.remove('unread');
                                    // Decrement unreadCount and update badge immediately
                                    unreadCount--; 
                                    notificationCountSpan.textContent = unreadCount;
                                    // Ensure badge visibility is updated after decrementing
                                    if (unreadCount === 0) {
                                        notificationCountSpan.style.display = 'none';
                                    }
                                }
                            } catch (error) {
                                console.error('Error marking notification as read:', error);
                            }
                        }
                    });
                });

                console.log('Calculated unreadCount:', unreadCount);

                // Update the unread count and badge visibility
                notificationCountSpan.textContent = unreadCount;
                if (unreadCount > 0) {
                    notificationCountSpan.style.display = 'block'; // Ensure it's visible if count > 0
                } else {
                    notificationCountSpan.style.display = 'none'; // Hide if count is 0
                }
            }
        } catch (error) {
            console.error('Error fetching notifications:', error);
            notificationList.innerHTML = '<p class="no-notifications-message">Failed to load notifications.</p>';
        }
    }

    // Toggle dropdown visibility, only if elements exist
    if (notificationBell && notificationDropdown) {
        notificationBell.addEventListener('click', () => {
            notificationDropdown.classList.toggle('show');
            // Fetch notifications every time the bell is clicked
            if (notificationDropdown.classList.contains('show')) {
                fetchAndRenderNotifications();
            }
        });
    }


    // Close the dropdown if the user clicks outside of it
    window.addEventListener('click', (event) => {
        if (notificationBell && notificationDropdown && !notificationBell.contains(event.target) && !notificationDropdown.contains(event.target)) {
            notificationDropdown.classList.remove('show');
        }
    });

    // Mark all as read functionality, only if element exists
    if (markAllReadButton) {
        markAllReadButton.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/notifications/mark_all_read', {
                    method: 'POST',
                });
                if (response.ok) {
                    // Re-fetch and render notifications to update the UI
                    fetchAndRenderNotifications();
                    flashMessage('All notifications marked as read!', 'success');
                }
            } catch (error) {
                    console.error('Error marking all as read:', error);
            }
        });
    }
    
    // Function to add a flash message (assuming a simple implementation)
    function flashMessage(message, type) {
        // You would need to implement this function to display a message to the user.
        // A simple alert or a toast notification library could be used.
        console.log(`Flash (${type}): ${message}`);
    }

    // Initial fetch of notifications
    fetchAndRenderNotifications();

});
    </script>
</body>
</html>