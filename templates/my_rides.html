<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Rides - TripBuddy</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}"> {# Reusing dashboard CSS for consistency #}
    <style>
        .my-rides-container {
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .my-rides-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .my-rides-header h1 {
            font-size: 2.2em;
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
        }

        .my-rides-header h1 i {
            margin-right: 10px;
            color: #007bff;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-buttons .btn {
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95em;
        }

        .filter-buttons .btn-primary {
            background-color: #007bff;
            color: #fff;
            border: 1px solid #007bff;
        }

        .filter-buttons .btn-secondary {
            background-color: #f8f9fa;
            color: #007bff;
            border: 1px solid #007bff;
        }

        .filter-buttons .btn-primary:hover,
        .filter-buttons .btn-secondary:hover {
            opacity: 0.9;
        }

        .filter-buttons .btn.active {
            background-color: #0056b3;
            border-color: #0056b3;
            color: #fff;
        }

        .rides-list-section {
            margin-top: 30px;
        }

        .ride-category-title {
            font-size: 1.8em;
            color: #555;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .ride-category-title i {
            margin-right: 10px;
            color: #28a745; /* Green for offered rides */
        }
        .ride-category-title.rented i {
            color: #ffc107; /* Orange for rented rides */
        }

        .ride-card {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .ride-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        .ride-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .ride-card-header .ride-status {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 5px;
            color: #fff;
        }

        .ride-card-header .ride-status.active { background-color: #28a745; } /* Green */
        .ride-card-header .ride-status.completed { background-color: #6c757d; } /* Gray */
        .ride-card-header .ride-status.cancelled { background-color: #dc3545; } /* Red */
        .ride-card-header .ride-status.pending { background-color: #ffc107; } /* Yellow */

        .ride-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .ride-detail-item {
            background-color: #eff6ff;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.95em;
            color: #444;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ride-detail-item i {
            color: #007bff;
        }

        .ride-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .ride-actions .btn {
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9em;
        }

        .no-rides-message {
            text-align: center;
            padding: 40px;
            background-color: #f0f8ff;
            border: 1px dashed #cce5ff;
            border-radius: 8px;
            color: #0056b3;
            font-size: 1.1em;
            margin-top: 30px;
        }
        .no-rides-message i {
            margin-right: 10px;
            color: #007bff;
        }

        /* Basic responsiveness */
        @media (max-width: 768px) {
            .my-rides-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .filter-buttons {
                width: 100%;
                justify-content: stretch;
            }
            .filter-buttons .btn {
                flex-grow: 1;
                text-align: center;
            }
            .ride-details-grid {
                grid-template-columns: 1fr;
            }
            .ride-actions {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>

    <header class="dashboard-header">
        <div class="header-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='images/tripbuddy.png') }}" alt="TripBuddy Logo" class="logo-img">
            </div>
            <div class="header-right-section">
                <nav class="dashboard-nav-header">
                    <ul>
                        <li><a href="{{ url_for('find_rides') }}">Find Rides</a></li>
                        <li><a href="{{ url_for('post_ride') }}">Post Ride</a></li>
                    </ul>
                </nav>
                <div class="header-actions">
                    <button class="notification-bell" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notification-count">0</span>
                    </button>
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="dropdown-header">
                            <h3>Notifications</h3>
                            <span class="mark-all-read" id="mark-all-read">Mark all as read</span>
                        </div>
                        <div class="notification-list" id="notification-list">
                            <p class="no-notifications-message">No new notifications.</p>
                        </div>
                        <div class="dropdown-footer">
                            <a href="#">View All Notifications</a>
                        </div>
                    </div>
                    <a href="{{ url_for('dashboard') }}" class="logout-btn-header">Dashboard</a>
                    <a href="{{ url_for('logout') }}" class="logout-btn-header">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="my-rides-container">
            <div class="my-rides-header">
                <h1><i class="fas fa-history"></i> My Ride History</h1>
                <div class="filter-buttons">
                    <a href="{{ url_for('my_rides', filter='all') }}" class="btn {% if filter == 'all' %}btn-primary active{% else %}btn-secondary{% endif %}">All Rides</a>
                    <a href="{{ url_for('my_rides', filter='offered') }}" class="btn {% if filter == 'offered' %}btn-primary active{% else %}btn-secondary{% endif %}">Offered Rides</a>
                    <a href="{{ url_for('my_rides', filter='rented') }}" class="btn {% if filter == 'rented' %}btn-primary active{% else %}btn-secondary{% endif %}">Rented Rides</a>
                </div>
            </div>

            <section class="rides-list-section">
                {% if offered_rides or rented_rides %}
                    {% if offered_rides and (filter == 'all' or filter == 'offered') %}
                        <h2 class="ride-category-title"><i class="fas fa-car-side"></i> Your Offered Rides</h2>
                        {% for ride in offered_rides %}
                            <div class="ride-card">
                                <div class="ride-card-header">
                                    <span>{{ ride.start_location }} to {{ ride.end_location }}</span>
                                    <span class="ride-status {{ ride.status_class }}">{{ ride.status }}</span>
                                </div>
                                <div class="ride-details-grid">
                                    <div class="ride-detail-item"><i class="fas fa-calendar-alt"></i> {{ ride.date.strftime('%Y-%m-%d') }}</div>
                                    <div class="ride-detail-item"><i class="fas fa-clock"></i> {{ ride.time }}</div>
                                    <div class="ride-detail-item"><i class="fas fa-users"></i> Seats: {{ ride.seats_available }} / {{ ride.total_seats }}</div>
                                    <div class="ride-detail-item"><i class="fas fa-tag"></i> Price: ₹{{ "%.2f"|format(ride.price) }}</div>
                                </div>
                                <div class="ride-actions">
                                    <a href="{{ url_for('edit_ride', ride_id=ride.id) }}" class="btn btn-info">Edit</a>
                                    <a href="{{ url_for('cancel_ride', ride_id=ride.id) }}" class="btn btn-danger">Cancel</a>
                                </div>
                            </div>
                        {% endfor %}
                    {% elif filter == 'offered' %}
                        <p class="no-rides-message"><i class="fas fa-info-circle"></i> You have not offered any rides yet.</p>
                    {% endif %}

                    {% if rented_rides and (filter == 'all' or filter == 'rented') %}
                        <h2 class="ride-category-title rented"><i class="fas fa-road"></i> Your Rented Rides</h2>
                        {% for booking in rented_rides %}
                            <div class="ride-card">
                                <div class="ride-card-header">
                                    <span>{{ booking.ride.start_location }} to {{ booking.ride.end_location }}</span>
                                    <span class="ride-status {{ booking.status_class }}">{{ booking.status }}</span>
                                </div>
                                <div class="ride-details-grid">
                                    <div class="ride-detail-item"><i class="fas fa-calendar-alt"></i> {{ booking.ride.date.strftime('%Y-%m-%d') }}</div>
                                    <div class="ride-detail-item"><i class="fas fa-clock"></i> {{ booking.ride.time }}</div>
                                    <div class="ride-detail-item"><i class="fas fa-user"></i> Driver: {{ booking.ride.driver.username }}</div>
                                    <div class="ride-detail-item"><i class="fas fa-ticket-alt"></i> Seats Booked: {{ booking.seats_booked }} / {{ booking.ride.seats }}</div>>
                                    <div class="ride-detail-item"><i class="fas fa-money-bill-wave"></i> Total Paid: ₹{{ "%.2f"|format(booking.total_price) }}</div>
                                </div>
                                <div class="ride-actions">
                                    <a href="{{ url_for('view_booking_details', booking_id=booking.id) }}" class="btn btn-info">View Details</a>
                                    <a href="{{ url_for('cancel_booking', booking_id=booking.id) }}" class="btn btn-danger">Cancel Booking</a>
                                </div>
                            </div>
                        {% endfor %}
                    {% elif filter == 'rented' %}
                        <p class="no-rides-message"><i class="fas fa-info-circle"></i> You have not rented any rides yet.</p>
                    {% endif %}
                {% else %}
                    <p class="no-rides-message"><i class="fas fa-info-circle"></i> You have no ride history yet. Start by <a href="{{ url_for('find_rides') }}">finding a ride</a> or <a href="{{ url_for('post_ride') }}">offering one</a>!</p>
                {% endif %}
            </section>
        </div>
    </main>

    <footer class="main-footer section-padding">
        <div class="footer-container container">
            <div class="footer-links-group">
                <h4>Quick Links</h4>
                <a href="{{ url_for('home') }}">Home</a>
                <a href="{{ url_for('home') }}#how-it-works">How It Works</a>
                <a href="{{ url_for('about') }}">About Us</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
            </div>
            <div class="footer-contact-group">
                <h4>Contact Us</h4>
                <p><i class="fas fa-envelope"></i> Email: support@tripbuddy.com</p>
                <p><i class="fas fa-phone"></i> Phone: +91-98765XXXXX</p>
                <p><i class="fas fa-map-marker-alt"></i> Address: 123,Lona,Delhi, India</p>
            </div>
            <div class="footer-social-group">
                <h4>Follow Us</h4>
                <div class="social-icons">
                    <a href="https://www.facebook.com" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="https://www.twitter.com" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="https://www.linkedin.com" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
            <div class="footer-newsletter-group">
                <h4>Subscribe to Our Newsletter</h4>
                <form class="newsletter-form">
                    <input type="email" placeholder="Your email" required />
                    <button type="submit">Subscribe</button>
                </form>
            </div>
        </div>
        <p class="footer-copy">&copy; 2025 TripBuddy. All rights reserved.</p>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBell = document.querySelector('.notification-bell');
            const notificationDropdown = document.getElementById('notification-dropdown');
            const notificationCountBadge = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const markAllReadBtn = document.getElementById('mark-all-read');
            const noNotificationsMessage = notificationList.querySelector('.no-notifications-message'); // Get the placeholder message

            let notifications = []; // This will now be populated from the backend

            // Helper function to format timestamps
            function formatTimestamp(isoString) {
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = now - date;
                const diffSeconds = Math.round(diffMs / 1000);
                const diffMinutes = Math.round(diffSeconds / 60);
                const diffHours = Math.round(diffMinutes / 60);
                const diffDays = Math.round(diffHours / 24);
                const diffMonths = Math.round(diffDays / 30.44); // Average days in a month
                const diffYears = Math.round(diffDays / 365.25); // Average days in a year

                if (diffSeconds < 60) {
                    return `${diffSeconds} second${diffSeconds === 1 ? '' : 's'} ago`;
                } else if (diffMinutes < 60) {
                    return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
                } else if (diffHours < 24) {
                    return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
                } else if (diffDays < 7) {
                    return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
                } else if (diffMonths < 12) {
                    return `${diffMonths} month${diffMonths === 1 ? '' : 's'} ago`;
                } else {
                    return `${diffYears} year${diffYears === 1 ? '' : 's'} ago`;
                }
            }

            // Function to fetch notifications from the backend
            async function fetchNotifications() {
                try {
                    const response = await fetch('/api/notifications');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    notifications = await response.json();
                    renderNotifications();
                } catch (error) {
                    console.error('Error fetching notifications:', error);
                    // Optionally display an error message to the user
                    notificationList.innerHTML = '<p class="no-notifications-message" style="color:red;">Failed to load notifications.</p>';
                    updateNotificationCount(0); // Hide badge on error
                }
            }

            // Function to render notifications
            function renderNotifications() {
                notificationList.innerHTML = ''; // Clear existing notifications
                let unreadCount = 0;

                if (notifications.length === 0 || notifications.every(notif => notif.is_read)) {
                    // Show "No new notifications" only if there are no notifications or all are read
                    if (noNotificationsMessage) { // Ensure the element exists
                        notificationList.appendChild(noNotificationsMessage);
                    } else {
                        const message = document.createElement('p');
                        message.classList.add('no-notifications-message');
                        message.textContent = 'No new notifications.';
                        notificationList.appendChild(message);
                    }
                    updateNotificationCount(0);
                    return;
                }

                notifications.forEach(notif => {
                    if (!notif.is_read) { // Use is_read from backend
                        unreadCount++;
                    }
                    const notificationItem = document.createElement('div');
                    notificationItem.classList.add('notification-item');
                    if (!notif.is_read) { // Use is_read for class
                        notificationItem.classList.add('unread');
                    }
                    notificationItem.dataset.id = notif.id; // Store ID for easy access

                    notificationItem.innerHTML = `
                        <div class="notification-item-header">
                            <span class="notification-type">${notif.type || 'General'}</span>
                            <span class="timestamp">${formatTimestamp(notif.timestamp)}</span>
                        </div>
                        <div class="notification-item-content">
                            ${notif.message}
                        </div>
                    `;
                    notificationList.appendChild(notificationItem);

                    // Add click listener to mark as read
                    notificationItem.addEventListener('click', async function() {
                        if (!notif.is_read) { // Only try to mark as read if it's currently unread
                            await markNotificationAsRead(notif.id);
                        }
                    });
                });

                updateNotificationCount(unreadCount);
            }

            // Function to update the notification count badge
            function updateNotificationCount(count) {
                if (count > 0) {
                    notificationCountBadge.textContent = count;
                    notificationCountBadge.style.display = 'block';
                } else {
                    notificationCountBadge.style.display = 'none';
                }
            }

            // Function to mark a single notification as read on the backend
            async function markNotificationAsRead(id) {
                try {
                    const response = await fetch(`/api/notifications/${id}/mark_read`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    if (response.ok) {
                        const notification = notifications.find(n => n.id === id);
                        if (notification) {
                            notification.is_read = true; // Update local state
                            renderNotifications(); // Re-render to update UI
                        }
                    } else {
                        console.error('Failed to mark notification as read:', await response.text());
                    }
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            }

            // Function to mark all notifications as read on the backend
            markAllReadBtn.addEventListener('click', async function() {
                try {
                    const response = await fetch('/api/notifications/mark_all_read', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    if (response.ok) {
                        notifications.forEach(notif => {
                            notif.is_read = true; // Update local state
                        });
                        renderNotifications();
                    } else {
                        console.error('Failed to mark all notifications as read:', await response.text());
                    }
                } catch (error) {
                    console.error('Error marking all notifications as read:', error);
                }
            });

            // Toggle dropdown visibility and fetch notifications
            notificationBell.addEventListener('click', async function(event) {
                notificationDropdown.classList.toggle('show');
                if (notificationDropdown.classList.contains('show')) {
                    await fetchNotifications(); // Fetch and render when dropdown opens
                }
                event.stopPropagation();
            });

            // Close dropdown if clicked outside
            document.addEventListener('click', function(event) {
                if (!notificationDropdown.contains(event.target) && !notificationBell.contains(event.target)) {
                    notificationDropdown.classList.remove('show');
                }
            });

            // Initial fetch of notifications when page loads
            fetchNotifications();

            // Optional: Periodically fetch notifications (e.g., every 60 seconds)
            // setInterval(fetchNotifications, 60000); // Fetch every minute
        });
    </script>
</body>
</html>